name: Version Check

on:
  pull_request:
    branches: [main]

jobs:
  version-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check VERSION was bumped
        run: |
          git fetch origin main
          PR_VERSION="$(cat VERSION)"
          MAIN_VERSION="$(git show origin/main:VERSION 2>/dev/null || echo '')"

          if [ "$PR_VERSION" = "$MAIN_VERSION" ]; then
            echo "::error::VERSION file was not updated. Please bump the version."
            exit 1
          fi

          echo "Version bumped: $MAIN_VERSION -> $PR_VERSION"

      - name: Check CHANGELOG has entry for version
        run: |
          VERSION="$(cat VERSION)"
          if ! grep -qF "## [$VERSION]" CHANGELOG.md; then
            echo "::error::CHANGELOG.md has no entry for version $VERSION"
            exit 1
          fi

          echo "CHANGELOG.md has entry for version $VERSION"
